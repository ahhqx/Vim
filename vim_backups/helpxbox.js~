
// 获取知识点
formnode=D.query("#J-form .xbox-form")[0];
if(data!=""){
	for(i=0;i<3;i++){
		if(data["content"+i]!=undefined && data["content"+i]!=""){
			node=formnode.cloneNode(true);
			node.getElementsByTagName("input")[0].value=data["title"+i];
			node.getElementsByTagName("textarea")[0].value=data["content"+i];
			D.get("J-form").appendChild(node);
		}
	}
	formnode_len=D.query("#J-form .xbox-form").length;
	if(formnode_len>1){
		formnode.parentNode.removeChild(formnode);
		reformname();
	}
	if(data["autoOpen"]=="true"){
		D.query("#J-autoopen input")[1].checked=true;
	}
	if(data["relateHelp"]!=""){
		D.get("J-relateBox").checked=true;
		D.get("J-relateHelp").disabled=false;
		D.removeClass("J-relateHelp","dis");
		D.get("J-relateHelp").value=data["relateHelp"];
	}
	if(data["onlineChat"]=="true"){
		D.get("J-onlineChat").checked=true;
	}
	if(data["hotLine"]=="true"){
		D.get("J-hotLine").checked=true;
	}
}else{
	writeform();
}

// 重新命表单的名称
function reformname(){
	xnode=D.query("#J-form .xbox-form");
	xnode_len=xnode.length;
	for(i=0;i<xnode_len;i++){
		xnode[i].getElementsByTagName("input")[0].setAttribute("name","title"+i);
		xnode[i].getElementsByTagName("textarea")[0].setAttribute("name","content"+i);
	}
	writeform();
}

// 是否有更多相关帮助的操作
E.on("J-relateBox","click",function(){
	if(D.get("J-relateBox").checked==false){
		D.get("J-relateHelp").value="";
		D.get("J-relateHelp").disabled=true;
		D.addClass("J-relateHelp","dis");
	}else{
		D.get("J-relateHelp").disabled=false;
		D.removeClass("J-relateHelp","dis");
	}
});

var firstTextArea=0;

// 添加知识点
formnode=D.query("#J-form .xbox-form")[0];
E.on("J-addform","click",function(ev){
	form=D.query("#J-form .xbox-form");
	form_len=form.length;
	if(form_len>=3){
		D.removeClass("J-adderr","fn-hidden");
	}else{
		node=formnode.cloneNode(false);
		node.innerHTML = formnode;
		node.getElementsByTagName("input")[0].value="请输入帮助标题(选填)";
		D.removeClass(node.getElementsByTagName("input")[0],"act");
		node.getElementsByTagName("textarea")[0].value="请输入帮助内容(必填)";
		D.removeClass(node.getElementsByTagName("textarea")[0],"act");
		D.get("J-form").appendChild(node);
		reformname();
		
		var addBr = D.query('a.J_addBR',node)[0];
		E.on(addBr,'click',function(ev){
			var area = D.query('textarea',this.parentNode.parentNode)[0];
			if(area.value=="请输入帮助标题(选填)" || area.value=="请输入帮助内容(必填)"){
				area.value='<br/>';
			}else{
				area.value += '<br/>';
			}
			E.preventDefault(ev);
		});
		var addA = D.query('a.J_addA',node)[0];
		E.on(addA,'click',function(ev){
			var area = D.query('textarea',this.parentNode.parentNode)[0];
			if(area.value=="请输入帮助标题(选填)" || area.value=="请输入帮助内容(必填)"){
				area.value='[url=链接地址]链接文字[/url]';
			}else{
				area.value += '[url=链接地址]链接文字[/url]';
			}
			E.preventDefault(ev);
		});
		
	}
	firstTextArea = 1;
	E.preventDefault(ev);
});

// 删除知识点
function delform(button,ev){
	node=button.parentNode.parentNode;
	node.parentNode.removeChild(node);
	reformname();
	D.addClass("J-adderr","fn-hidden");
	E.stopEvent(ev);
}

// 下一步 or 上一步
E.on("J-tonext","click",function(){
	if(chkform()!=false){
		D.addClass("J-adderr","fn-hidden");
		if(D.query("#J-autoopen input")[1].checked){
			D.get("Js-autoopen").innerHTML="弹出类型：自动弹出";
		}else{
			D.get("Js-autoopen").innerHTML="弹出类型：点击弹出";
		}
		D.addClass("J-errmsg","fn-hidden");
		D.addClass("J-step1","fn-hidden");
		D.removeClass("J-step2","fn-hidden");
		insHelpFn();
	}
});
E.on("J-topre","click",function(){
	D.addClass("J-step2","fn-hidden");
	D.removeClass("J-step1","fn-hidden");
});

// 提交
E.on("J-submit","click",function(){
	if(chkform()!=false){
		D.addClass("J-errmsg","fn-hidden");
		D.get("J-editform").submit();
	}
});

// 表单验证
function chkform(){
	node=D.query("#J-form .xbox-form");
	node_len=node.length;
	for(i=0;i<node_len;i++){
		val=node[i].getElementsByTagName("input")[0].value;
		if(val!="" && val!="请输入帮助标题(选填)"){
			content=node[i].getElementsByTagName("textarea")[0].value;
			if(content=="" || content=="请输入帮助内容(必填)"){
				D.get("J-errmsg").innerHTML="* 有帮助标题的知识点，必须填写帮助内容！";
				D.removeClass("J-errmsg","fn-hidden");
				return false;
			}
		}
	}
	var vtrue=0;
	for(i=0;i<node_len;i++){
		content=node[i].getElementsByTagName("textarea")[0].value;
		if(content!="" && content!="请输入帮助内容(必填)"){
			vtrue++;
		}
	}
	if(vtrue==0){
		D.get("J-errmsg").innerHTML="* 请至少需要填写一个知识点！";
		D.removeClass("J-errmsg","fn-hidden");
		return false;
	}
	for(i=0;i<node_len;i++){
		val=node[i].getElementsByTagName("input")[0].value;
		content=node[i].getElementsByTagName("textarea")[0].value;
		if(val=="请输入帮助标题(选填)"){node[i].getElementsByTagName("input")[0].value="";}
		if(content=="请输入帮助内容(必填)"){node[i].getElementsByTagName("textarea")[0].value="";}
	}
}

// 表单获取焦点及失去焦点细节
function writeform(){
	E.on(D.query("#J-form input,#J-form textarea"),"focus",function(){
		if(this.value=="请输入帮助标题(选填)" || this.value=="请输入帮助内容(必填)"){
			this.value="";
		}
		D.addClass(this,"act");
	});
	E.on(D.query("#J-form input"),"blur",function(){
		if(this.value=="" || this.value=="请输入帮助标题(选填)"){
			this.value="请输入帮助标题(选填)";
			D.removeClass(this,"act");
		}
	});
	E.on(D.query("#J-form textarea"),"blur",function(){
		if(this.value=="" || this.value=="请输入帮助内容(必填)"){
			this.value="请输入帮助内容(必填)";
			D.removeClass(this,"act");
		}
	});
}

//下一步，预览窗口
	function insHelpFn(){
		
		var helpDom = "<div class=\"instanceHelp\"><div class=\"helpHead\"></div>\r\n\
		<div class=\"helpBody\">\r\n\
		<em class=\"m-help\">帮助信息</em>\r\n\
		<a class=\"closeHelp\" href=\"javascript:void(0)\">关闭</a>\r\n\
		<div class=\"helpUl\">\r\n\
		</div>\r\n\
		</div>\r\n\
		<div class=\"helpFoot\"></div>\r\n\
		<div class=\"helpArrow\" style=\"top:20px;\"></div></div>"; 

		var helpRankDom = "<div class=\"helpRank fn-clear\"><p>是否已解决了您的问题？</p><a href=\"javascript:void(0)\" class=\"helpYes\">是</a><a href=\"javascript:void(0)\" class=\"helpNo\">否</a></div>";
		
		var helpPreview = D.query('#J-step2 #editPreview')[0];
		helpPreview.innerHTML=helpDom;

		var supCnt = data,
			helpLinkDom = '',
			helpBodyDom = '',
			helpListDom = '<dl class=\"tip-faq\">',
			regLink = /(\[url\=)(\S[^[]+)(\])(\S[^[]+)(\[\/url\])/g;

		var xboxFrom = D.query('.xbox-form');
		

		for(var i = 0;i < xboxFrom.length;i++){
			var title = xboxFrom[i].getElementsByTagName("input")[0].value;

			var cnt = xboxFrom[i].getElementsByTagName("textarea")[0].value;
			
			if(cnt.length > 0 && regLink.test(cnt)){
				cnt = cnt.replace(regLink,'<a href="$2" target="_blank">$4</a>');
			};
			if(title.length>0){
					helpListDom += '<dt>' + title + '</dt>';
					helpListDom += '<dd>' + cnt + '</dd>';
				}else{
					helpListDom += (cnt.length > 0 ? '<dt class=\"inshelp-dt\">' + cnt + '</dt>' : '');
				}
		}
		helpListDom += '</dl>';
			

		//插入其它内容
			relateHelpDom = D.get("J-relateHelp").value ? '<a href=\"2' + D.get("J-relateHelp").value + '\" target=\"_blank\">更多相关帮助</a><em class=\"ft-bar\">|</em>' : '';
			onlineChatDom = D.get("J-onlineChat").checked ? '<a class=\"HelpOnlineChat\">咨询在线客服</a><em class=\"ft-bar\">|</em>' : '';
			hotLineDom = D.get("J-hotLine").checked ? '<span>24小时服务热线：0571-88156688</span>' : '';

		helpBodyDom += helpListDom + '<div class=\"helpLink link\"' + relateHelpDom + onlineChatDom + hotLineDom  + '</div>' + helpRankDom ;
		
		var helpDl = D.query('.helpUl',helpPreview)[0]; 
		helpDl.innerHTML += helpBodyDom;
	};			

if(firstTextArea!=1){
		var addBr = D.query('a.J_addBR');
		for(var i=0;i<addBr.length;i++){
			E.on(addBr[i],'click',function(ev){
				var area = D.query('textarea',this.parentNode.parentNode)[0];
				if(area.value=="请输入帮助标题(选填)" || area.value=="请输入帮助内容(必填)"){
					area.value='<br/>';
				}else{
					area.value += '<br/>';
				}
				E.preventDefault(ev);
			});	
		}	
		var addA = D.query('a.J_addA');
		for(var i=0;i<addA.length;i++){
			E.on(addA[i],'click',function(ev){
				var area = D.query('textarea',this.parentNode.parentNode)[0];
				if(area.value=="请输入帮助标题(选填)" || area.value=="请输入帮助内容(必填)"){
					area.value='[url=链接地址]链接文字[/url]';
				}else{
					area.value += '[url=链接地址]链接文字[/url]';
				}
				E.preventDefault(ev);
			});
		}
}

